=== Create and publish a newsletter
____
This scenario describes how to use the functionality of Newsletters API and Search API to create a _newsletter_ and send it to recipients.

*Prerequisites*: to follow this scenario, ensure that you have:

* One _permanent search_ (see the <<#create-a-search,Create a _search_>> and <<#change-the-parameters-of-a-search,Change the parameters of a _search_>> scenarios).
* One _contact list_ (see the <<#create-a-contact-list,Create a _contact list_>> scenario).

*Expected results*:

* A _newsletter_ is created, containing _search_ results from the previously created _search_.
* The _newsletter_ has a schedule that publishes it automatically every Monday at 09:00 AM.
* The _newsletter_ is sent to _users_ from the specified _contact list_.

*Related topics*: <<general/overview.adoc#search-api,Search API>>, <<general/overview.adoc#newsletters-api,Newsletters API>>, <<general/overview.adoc#subscriptions-api,Subscriptions API>>, <<general/overview.adoc#address-book-api,Address Book API>>
____

[float]
==== 1. Find the unique IDs of your recipients

Before you start creating the _newsletter_, you can run the `GET addressbook/contact_lists` request.
Use this request to return the ID of the _contact list_ that will receive the published _newsletter_. +
This is optional: you can skip this step and proceed to create the _newsletter_, because there is a separate method to subscribe _users_ to a _newsletter_.
To add recipients, run the `PUT newsletter/{{newsletter_uid}}/recipients` request at any point between steps 2 and 5 in this instruction.

----
curl --location --request GET 'https://{{API_link}}/addressbook/contact_lists' \
--header 'x-api-key: {{x-api-key}}' \
--header 'Authorization: Bearer {{access_token}}'
----

.Click here for the Address Book API response with the list of all available _contact lists_.
[%collapsible]
====
----
HTTP/1.1 200 OK
X-Total: 1
----
[source,json]
----
[
    {
        "id": 3362,
        "name": "Externals",
        "contacts": [
            {
                "id": "66707bb0bd445fdc47fb84cf557dfd15",
                "owner": "{{your_unique_user_ID}}",
                "email": "Juanita_Ma@hongkongexchange.hk",
                "first_name": "Juanita",
                "last_name": "Ma",
                "timezone": "",
                "type": "personal",
                "status": "Active"
            },
            {
                "id": "6664d12f6823297a859f25cf87534fa1",
                "owner": "{{your_unique_user_ID}}",
                "email": "Kesha_Williams@investor.biz",
                "first_name": "Kesha",
                "last_name": "Williams",
                "timezone": "",
                "type": "personal",
                "status": "Active"
            },
            {
                "id": "6655dbbcc24cb56fb205e53bb015595c",
                "owner": "{{your_unique_user_ID}}",
                "email": "Anthony_Lavey@mailme.com",
                "first_name": "Anthony",
                "last_name": "LaVey",
                "timezone": "",
                "type": "personal",
                "status": "Active"
            }
        ]
    },
    {...},
    {...}
]
----
====

The unique ID of the "Externals" _contact list_ is `3362`.

[float]
==== 2. Create a newsletter with specified recipients

Create a _newsletter_ that contains the recipients from the `3362` _contact list_.
A _newsletter_ has three levels:

1. Newsletter level (top level), where you set the general settings, including the recipients.
2. Section level, where you specify the content (next step in this scenario).
3. Article level, where you modify the content (out of scope for this scenario).

To create a _newsletter_, run the `POST newsletters` request with the following body, where:

* `"title"` specifies the name of the _newsletter_. +
`"title"` is the only obligatory parameter and must hold a unique value as string.
* `"description"` specifies the description of the _newsletter_ that appears under the name in the published HTML file. +
`"description"` accepts a string.
* `"publish_recipients"` object holds the arrays of `"users"` and `"user_lists"`, where you specify the IDs of users and _contact lists_ that receive the _newsletter_.

For simplicity, this request ignores all other parameters.
InfoNgen sets them to default values, or leaves them empty.

----
curl --location --request POST 'https://{{API_link}}/newsletters' \
--header 'Content-Type: application/json' \
--header 'x-api-key: {{x-api-key}}' \
--header 'Authorization: Bearer {{access_token}}' \
--data-raw
----
[source,json]
----
'{
    "title": "Newsletter for Externals",
    "description": "News about Exxon Mobil and Saudi Aramco LLC",
    "publish_recipients": {
        "users": [],
        "user_lists": [
            3362
        ]
    }
}'
----

The response returns the `201 Created` status code, which means that the request was successful.
The `Location` header in the response contains the unique ID of the created _newsletter_.

----
HTTP/1.1 201 Created
Location: {{API_link}}/newsletters/NL_0123456789
----

Check the result by running the following request with the unique ID from the `Location` response header:
----
curl --location --request GET 'https://{{API_link}}/newsletters/NL_0123456789' \
--header 'x-api-key: {{x-api-key}}' \
--header 'Authorization: Bearer {{access_token}}'
----

.Click here for Newsletters API response.
[%collapsible]
====

Note how InfoNgen processes your request:

* Your unique _user_ ID appears in the `"accessors"` array, giving you access to further operations with this _newsletter_.
* Your unique _user_ ID shows as the value of the `"owner"` field.
* Your unique _user_ ID is put into the `"preview_recipients"` and `"publish_recipients"` arrays, which means that you can receive the preview of the _newsletter_, as well as its final published form.

----
HTTP/1.1 200 OK
Content-Type: application/json
----

[source,json]
----
{
    "accessors": [
        "{{your_unique_user_ID}}"
    ],
    "archive_feed_enabled": true,
    "owner": "{{your_unique_user_ID}}",
    "article_feed_enabled": true,
    "title": "Newsletter for Externals",
    "id": "NL_0123456789",
    "render_publish_at": true,
    "use_provider_as_source": false,
    "allow_moving_items": false,
    "render_source": true,
    "render_author": false,
    "render_logo": true,
    "render_summary": true,
    "render_article_comments": true,
    "render_document_comments": true,
    "metadata": {...},
    "sections": [
        {
            "id": "SC_0123456789",
            "position": 0,
            "enable_section_summary": false,
            "image_extraction_flag": false
        }
    ],
    "description": "News about Exxon Mobil and Saudi Aramco LLC",
    "personal_comments": "",
    "publish_recipients": {
        "users": [
            "{{your_unique_user_ID}}",
            "66707bb0bd445fdc47fb84cf557dfd15",
            "6664d12f6823297a859f25cf87534fa1",
            "6655dbbcc24cb56fb205e53bb015595c"
        ],
        "user_lists": [
            3362
        ],
        "users_total": 4
    },
    "preview_recipients": {
        "users": [
            "{{your_unique_user_ID}}"
        ],
        "users_total": 1
    }
}
----

The response displays the newsletter with:

* One empty default section.
* Default rendering settings.
* Automatically enabled _feeds_ for the _newsletter_ and articles published in it.
* The publish recipients. +
*Note*: InfoNgen populates the `"users"` array within the `"publish_recipients"` object with the unique IDs of users from the `3362` _contact list_.

====

[float]
==== 3. Create a section with automatic import of content from a search

Each _newsletter_ is created with a default section: the section ID is `SC_0123456789` (see the API response in the previous step of this scenario).
The default section is created with the `"position": 0` parameter and holds no content.
To add content to the _newsletter_, create a new section and specify the source of your content.
The source of the content is the _permanent search_ from the <<#change-the-parameters-of-a-search,Change the parameters of a _search_>> scenario).

To create a section, run the `POST newsletters/NL_0123456789/sections` request with the following body, where:

* The value of the `"name"` parameter is the name of the section.
* The value of the `"description"` parameter is the description of the section that will appear under the section's name in the published _newsletter_.
* The values of the optional `"description_url"` and `"description_url_title"` parameters may contain additional descriptions. +
For example, put a link under the section that the recipients can use for contact.
* The value of the `"position"` parameter is the position of the created section. +
Section positions are zero-based, with the default section always having the `"position": 0` property.
* The value of the `"articles_display_limit"` is the number of articles displayed within the section in the published _newsletter_.
* The object `"auto_import_settings"` with the following parameter values:
** `"auto_import_on_publish"` set to `true` to automatically import new articles into the section when you publish the _newsletter_.
** `"date_range"` set to `"Last14Days"` to import the articles discovered by the _search_ within the last two weeks.
** `"import_bookmarks"` set to `false` to not process bookmarked _documents_, if you have any.
** `"max_docs_to_import"` set to `"25"` to import the latest 25 _documents_ discovered by the _search_ as articles into a section.
** `"search_ids"` array accepting the unique ID of the _search_, in this case `"7b6d78ca-a40f-4b24-9528-24200398c7b9"`.

----
curl --location --request POST 'https://{{API_link}}/newsletters/{{newsletter_uid}}/sections' \
--header 'Content-Type: application/json' \
--header 'x-api-key: {{x-api-key}}' \
--header 'Authorization: Bearer {{access_token}}' \
--data-raw
----
[source, json]
----
'{
    "name": "InfoNgen Search results",
    "description": "Latest articles discovered by InfoNgen",
    "description_url": "mailto:{{your_email_goes_here}}",
    "description_url_title": "Write to {{your_name}} for more information on this section.",
    "position": 1,
    "articles_display_limit": 25,
    "auto_import_settings": {
        "auto_import_on_publish": true,
        "date_range": "Last14Days",
        "import_bookmarks": false,
        "max_docs_to_import": "25",
        "search_ids": ["7b6d78ca-a40f-4b24-9528-24200398c7b9"]
    }
}'
----

The response returns the `201 Created` status code, which means that the request was successful.
The `Location` header in the response contains the unique ID of the created _newsletter_ section.

----
HTTP/1.1 201 Created
Location: {{API_link}}/newsletters/NL_0123456789/sections/SC_9876543210
----

InfoNgen adds default values to all parameters that are not specified in this POST request.

Check the result by running the following request with the unique ID from the `Location` response header:
----
curl --location --request GET 'https://{{API_link}}/newsletters/NL_0123456789/sections' \
--header 'x-api-key: {{x-api-key}}' \
--header 'Authorization: Bearer {{access_token}}'
----

.Click here for Newsletters API response.
[%collapsible]
====

----
HTTP/1.1 200 OK
Content-Type: application/json
----

[source,json]
----
[
    {
        "id": "SC_0123456789",
        "position": 0,
        "enable_section_summary": false,
        "image_extraction_flag": false
    },
    {
        "id": "SC_9876543210",
        "name": "InfoNgen Search results",
        "description": "Latest articles discovered by InfoNgen",
        "description_url": "mailto:{{your_email_goes_here}}",
        "description_url_title": "Write to {{your_name}} for more information on this section.",
        "position": 1,
        "enable_section_summary": false,
        "image_extraction_flag": false,
        "articles_display_limit": 25,
        "auto_import_settings": {
            "auto_import_on_publish": true,
            "date_range": "Last14Days",
            "image_position": "Undefined",
            "image_size": "Undefined",
            "import_bookmarks": false,
            "max_docs_to_import": 25,
            "search_ids": [
                "7b6d78ca-a40f-4b24-9528-24200398c7b9"
            ]
        }
    }
]
----

====

[float]
==== 4. Create a schedule for automatic publishing

To automate the publishing of _newsletters_, you can create _schedules_ to run the publishing process.

Newsletter schedules must be created in Subscriptions API.
To create a _schedule_, run the `PUT subscriptions/newsletter:NL_0123456789/schedules` request with the following settings:

* The path contains the ID of your _newsletter_ with the `newsletter:` prefix.
* In the `"properties"` array:
** The `"AutoPublishType"` parameter is set to `"Publish"` value to create a _schedule_ for publishing the _newsletter_.
** Your unique _user_ ID is the value of the `"NewsletterOwner"` parameter.
* The `"days"` array is populated with weekdays when you want to publish the _newsletter_ (`"Monday"` in this scenario).
* The `"recurrence"` parameter shows how often InfoNgen must publish the _newsletter_ (in seconds).
* The `"effective_from"` and `"effective_till"` parameters hold the times when the schedule must activate and stop.

----
curl --location --request PUT 'https://{{API_link}}/subscriptions/newsletter:NL_0123456789/schedules' \
--header 'Content-Type: application/json' \
--header 'x-api-key: {{x-api-key}}' \
--header 'Authorization: Bearer {{access_token}}' \
--data-raw
----
[source,json]
----
[
    {
        "payload":
        {
            "days":
                [
                    "Monday"
                ],
            "effective_from": "09:00:00",
            "effective_till": "09:59:59",
            "recurrence": 3600
        },
        "time_zones":
        [
            "Central Standard Time"
        ],
        "properties":
        {
            "AutoPublishType": "Publish",
            "NewsletterOwner": "{{your_unique_ID_here}}"
        }
    }
]
----

The response returns the `202 Accepted` status code, which means that the request was successful.

Check the result by running the following request: `GET subscriptions/newsletter:NL_0123456789`
----
curl --location --request GET 'https://{{API_link}}/subscriptions/newsletter:NL_0123456789' \
--header 'x-api-key: {{x-api-key}}' \
--header 'Authorization: Bearer {{access_token}}'
----

.Click here for the Subscriptions API response.
[%collapsible]
====

----
HTTP/1.1 200 OK
Content-Type: application/json
----

[source,json]
----
[
    {
        "uid": "newsletter:NL_0123456789",
        "kind": "newsletter",
        "enabled": true,
        "schedules": [
            {
                "uid": "newsletter:NL_0123456789",
                "payload":
                    {...},
                "time_zones":
                    [...],
                "recipients":
                    {...},
                "properties":
                    {...}
            }
        ]
    }
]
----
====

[float]
==== 5. Import articles into section

When you create a _newsletter_, you must import articles into sections before publishing it.
If you enable automatic publishing, InfoNgen imports new articles when you activate the preset specified in the section's `auto_import_settings` object.
Previously published articles are ignored.

To import articles into the section, run the `POST newsletters/NL_0123456789/sections/SC_9876543210/articles?import=true` request.
Note the `import=true` query parameter.

The response returns the `201 Created` status code, which means that the request was successful.
The `X-Total` header in the response contains the number of imported articles.

----
HTTP/1.1 201 Created
Location: {{API_link}}/newsletters/NL_0123456789/sections/SC_9876543210/articles/AR_0123456789,1123456789,2123456789,3123456789,...
X-Total: 25
----

[float]
==== 6. Preview and publish the newsletter

After creating the _newsletter_, adding recipients, and automating content import, you can publish the _newsletter_.
To make sure that everything is set up correctly, you can preview the _newsletter_ by running the `POST newsletters/NL_0123456789/preview` method.

The body of the _newsletter_ already contains your unique ID in the `"preview_recipients"` array.
You can override this setting by manually setting the unique IDs of preview recipients in the body of your request.
See example:

----
curl --location --request POST 'https://{{API_link}}/POST newsletters/NL_0123456789/preview' \
--header 'Content-Type: application/json' \
--header 'x-api-key: {{x-api-key}}' \
--header 'Authorization: Bearer {{access_token}}' \
--data-raw
----

[source,json]
----
'{
    "recipients":
        [
        "{{your_unique_ID_here}}"
        ]
}'
----

Newsletters API responds with `204 No Content` code.
InfoNgen assembles the _newsletter_ preview and sends it into your inbox, usually in a matter of several seconds.
This time depends on the number of articles that InfoNgen processes to compile the _newsletter_ preview.

[caption='{figure-caption} {counter:figure-number}. ']
.Example of a _newsletter_ preview
image::figs/Preview.png[alt=Example of a newsletter preview, width="650"]
&nbsp;

If the preview is satisfactory, you can publish the _newsletter_.
To publish the _newsletter_, run the `POST newsletters/NL_0123456789/publish` method.

Newsletters API responds with `204 No Content` code.
InfoNgen assembles the _newsletter_ and sends it into your inbox on the predefined schedule.
For first publishing, this happens in several seconds: this time depends on the number of articles that InfoNgen must process to compile the _newsletter_.

'''

image:icons/lightbulb.png[alt=Note icon, width="60", float="left"] If the preview or the final form of the _newsletter_ do not appear in your inbox within several minutes, check your "Spam" folder.
Make sure that emails from _@infongen.com_ domain are in the "Allowed domains" list.

'''

*Results*:

* The _newsletter_ with the specified schedule is created successfully.
* The _newsletter_ has a section that imports content from a _search_.
* The _newsletter_ can be previewed and sent to specified recipients.